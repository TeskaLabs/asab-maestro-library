define:
  type: rc/descriptor
  name: Telegraf
  url: https://github.com/influxdata/telegraf

descriptor:
  image: telegraf

  volumes:
    - "{{SLOW_STORAGE}}/{{INSTANCE_ID}}/data:/var/lib/influxdb2"

  environment:
    HOST_MOUNT_PREFIX: /hostfs
    HOST_PROC: /hostfs/proc
    HOST_SYS: /hostfs/sys
    # HOST_ETC: /hostfs/etc
    # HOST_VAR: /hostfs/var
    HOST_RUN: /hostfs/run

  volumes:
    # For a persistency of the configuration
    - "{{SITE}}/{{INSTANCE_ID}}/conf:/etc/telegraf:ro"
    # Logs
    - "{{SLOW_STORAGE}}/{{INSTANCE_ID}}/logs:/var/log/telegraf"
    # Mounting importang bits from the host
    - /proc:/hostfs/proc:ro
    - /sys:/hostfs/sys:ro
    - /run:/hostfs/run:ro

files:
  - "conf/telegraf.conf": |
      [global_tags]

      [agent]
        interval = "60s"
        round_interval = true
        metric_batch_size = 1000
        metric_buffer_limit = 10000
        collection_jitter = "0s"
        flush_interval = "10s"
        flush_jitter = "0s"
        precision = ""
        hostname = "{{NODE_ID}}"
        omit_hostname = false

      [[outputs.influxdb_v2]]
        urls = ["{{INFLUXDB_URL}}""]
        token = "{{INFLUXDB_TOKEN}}"
        organization = "{{INFLUXDB_ORG}}"
        bucket = "{{INFLUXDB_BUCKET}}"

      [[inputs.cpu]]
        percpu = true
        totalcpu = true
        collect_cpu_time = true
        report_active = true
