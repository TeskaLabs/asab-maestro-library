
define:
  type: rc/descriptor
  name: Seacat Auth
  url: https://github.com/TeskaLabs/seacat-auth

descriptor:
  image: teskalabs/seacat-auth
  
  environment:
    # provisioning is skipped in automated deployments
    SEACAT_AUTH_PROVISIONING: 0

  volumes:
    - "{{SITE}}/{{INSTANCE_ID}}/conf:/conf:ro"
    - "{{FAST_STORAGE}}/{{INSTANCE_ID}}/data:/data"

sherpas:
# Sherpas containers: akin to their namesake mountain guides, these containers provide essential support and guidance throughout the application's lifecycle.
# provide a name to your sherpa and a descriptor for its very own container.
  mongo:
    image: library/mongo
    entrypoint: ["mongosh", "--nodb", "--file", "/script/mongo-insert.js"]
    command: ["echo", "DONE"]
    volumes:
    - "{{SITE}}/{{INSTANCE_ID}}/script:/script"
    environment:
      MONGO_HOSTNAMES: "{{MONGO_HOSTNAMES}}"

asab:
  configname: conf/seacatauth.conf
  config:
    general:
      public_api_base_url: "{{PUBLIC_URL}}/auth/api"
      auth_webui_base_url: "{{PUBLIC_URL}}/auth"

    seacatauth:
      private_key: /conf/private-key.pem  # The private file key will be added by ASAB Remote Control / SeaCat Auth tech

    asab:storage:
      type: mongodb
      mongodb_uri: "{{MONGO_URI}}"
      mongodb_database: auth
      aes_key: null  # Will be filled by ASAB Remote Control

    seacatauth:credentials:mongodb:default:
      mongodb_uri: "{{MONGO_URI}}"
      mongodb_database: auth
      tenants: yes
      register: no

    seacatauth:communication:email:smtp:
      # By default, SMTP configuration is mocked - e-mails are printed into log of seacat-auth
      # Configuration of SMTP server should be done in UI > Maintenance > Configuration > General
      # TODO ^^ this is not possible now
      host: <mocked>

nginx:
  https:
    api:
      port: 8900  # The REST API is at tcp/8893

    location = /_oauth2_introspect:
      - internal
      - proxy_method POST
      - proxy_set_body "$http_authorization"
      - proxy_set_header X-Request-URI "$request_uri"
      - proxy_pass http://{{UPSTREAM}}/openidconnect/introspect/nginx
      - proxy_ignore_headers Cache-Control Expires Set-Cookie

    location /api/openidconnect:
      - rewrite ^/api/openidconnect/(.*) /openidconnect/$1 break;
      - proxy_pass http://{{UPSTREAM}};
