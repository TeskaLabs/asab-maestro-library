define:
  type: rc/descriptor
  name: NGINX
  url: https://nginx.org

descriptor:
  image: library/nginx

  volumes:
    # Read-only NGINX configuration
    - "{{SITE}}/{{INSTANCE_ID}}/conf.d:/etc/nginx/conf.d:ro"
    # Webroot directory
    - "{{SLOW_STORAGE}}/{{INSTANCE_ID}}/webroot:/webroot"
    # Logs
    - "{{SLOW_STORAGE}}/{{INSTANCE_ID}}/logs:/var/log/nginx"
    # This is where web ui archives are cached to prevent unnecessary downloads
    - "{{SLOW_STORAGE}}/{{INSTANCE_ID}}/cache:/cache"

  secrets:
    - "nginx--certificate.pem"
    - "nginx--private-key.pem"

  healthcheck:
    test: ["CMD", "service", "nginx", "status"]
    interval: 60s
    timeout: 10s
    retries: 5
    start_period: 10s

secrets:
  # Generated by the tech/nginx.py
  "nginx--certificate.pem":
    file: "{{SITE}}/{{INSTANCE_ID}}/secrets/certificate.pem"

  # Generated by the tech/nginx.py
  "nginx--private-key.pem":
    file: "{{SITE}}/{{INSTANCE_ID}}/secrets/private-key.pem"

files:
  - "conf.d/"
  - "sherpa/"

sherpas:
  webui-dist:
    image: library/nginx

    environment:
      ASAB_WEBUI_DISTRIBUTION_APP: lmio:v23.32-beta seacat-auth:v23.29-alpha

    command: ["bash", "-e", "/sherpa/webui-dist.sh"]

    volumes:
      # This is where web ui archives are cached to prevent unnecessary downloads
      - "{{SLOW_STORAGE}}/{{INSTANCE_ID}}/cache:/cache"
      # Webroot directory
      - "{{SLOW_STORAGE}}/{{INSTANCE_ID}}/webroot:/webroot"
      # Read-only NGINX configuration
      - "{{SITE}}/{{INSTANCE_ID}}/sherpa:/sherpa:ro"
