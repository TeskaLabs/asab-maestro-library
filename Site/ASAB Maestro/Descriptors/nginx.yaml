define:
  type: rc/descriptor
  name: NGINX
  url: https://nginx.org

descriptor:
  image: library/nginx

  # Aligned with "container user" in NGINX container
  user: 10001:10001

  volumes:
    # Read-only NGINX configuration
    - "{{SITE}}/{{INSTANCE_ID}}/conf.d:/etc/nginx/conf.d:ro"
    # Webroot directory
    - "{{SLOW_STORAGE}}/{{INSTANCE_ID}}/webroot:/webroot:ro"
    # Logs
    - "{{SLOW_STORAGE}}/{{INSTANCE_ID}}/logs:/var/log/nginx"
    # NGINX writes into /var/cache/nginx
    - "{{SLOW_STORAGE}}/{{INSTANCE_ID}}/cache:/var/cache/nginx"
    # NGINX writes into /var/run
    - "{{SLOW_STORAGE}}/{{INSTANCE_ID}}/run:/var/run"

  healthcheck:
    test: ["CMD", "service", "nginx", "status"]
    interval: 60s
    timeout: 10s
    retries: 5
    start_period: 10s

  depends_on:
    # NGINX is started only after the sherpa has successfully completed
    '{{INSTANCE_ID}}-webapp-dist': {condition: service_completed_successfully}

files:
  - "conf.d/"
  - "sherpa/"

sherpas:
  webapp-dist:
    image: docker.teskalabs.com/asab/asab-governator:stable  # We use ASAB Governator image as a sherpa

    command: sh -e /sherpa/webapp-dist.sh

    volumes:
      # This is where web ui archives are cached to prevent unnecessary downloads
      - "{{SLOW_STORAGE}}/{{INSTANCE_ID}}/cache:/var/cache/nginx"
      # Webroot directory
      - "{{SLOW_STORAGE}}/{{INSTANCE_ID}}/webroot:/webroot"
      # Read-only NGINX configuration
      - "{{SITE}}/{{INSTANCE_ID}}/sherpa:/sherpa:ro"
