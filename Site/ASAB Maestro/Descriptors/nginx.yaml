define:
  type: rc/descriptor
  name: NGINX
  url: https://nginx.org

descriptor:
  image: library/nginx

  volumes:
    # Read-only NGINX configuration
    - "{{SITE}}/{{INSTANCE_ID}}/conf.d:/etc/nginx/conf.d:ro"
    # Webroot directory
    - "{{SLOW_STORAGE}}/{{INSTANCE_ID}}/webroot:/webroot"
    # Logs
    - "{{SLOW_STORAGE}}/{{INSTANCE_ID}}/logs:/var/log/nginx"
    # This is where web ui archives are cached to prevent unnecessary downloads
    - "{{SLOW_STORAGE}}/{{INSTANCE_ID}}/cache:/cache"

  secrets:
    - "{{INSTANCE_ID}}--certificate.pem"
    - "{{INSTANCE_ID}}--private-key.pem"

  healthcheck:
    test: ["CMD", "service", "nginx", "status"]
    interval: 60s
    timeout: 10s
    retries: 5
    start_period: 10s

secrets:
  # Generated by the tech/nginx.py
  "{{INSTANCE_ID}}--certificate.pem":
    file: "{{SITE}}/{{INSTANCE_ID}}/secrets/certificate.pem"

  # Generated by the tech/nginx.py
  "{{INSTANCE_ID}}--private-key.pem":
    file: "{{SITE}}/{{INSTANCE_ID}}/secrets/private-key.pem"

files:
  - "conf.d/"
  - "sherpa/"
