define:
  type: rc/descriptor
  name: Web-based ZooKeeper UI
  url: https://zoonavigator.elkozmon.com/

descriptor:
  image: jupyter/base-notebook

  volumes:
    - "{{SLOW_STORAGE}}/{{INSTANCE_ID}}:/home/jovyan"
    - "{{SITE}}/{{INSTANCE_ID}}/.jupyter:/home/jovyan/.jupyter"


files:
  ".jupyter/jupyter_notebook_config.py": |
    c.ServerApp.token = "{{JUPYTER_TOKEN}}"
    c.ServerApp.allow_origin = '*'
    c.ServerApp.port = 8888
    c.NotebookApp.open_browser = False
    c.ServerApp.allow_remote_access = True
    c.ServerApp.trust_xheaders = True

    c.ServerApp.custom_display_url = '{{PUBLIC_URL}}/jupyter'
    c.ServerApp.base_url = '/jupyter'
    c.ServerApp.quit_button = False


asab-config:
  Tools:
     Zoonavigator: 
        file:
          {
              "Tool": {
                  "image": "media/tools/zookeeper.svg",
                  "name": "Jupyter Notebook",
                  "url": "{{PUBLIC_URL}}/jupyter"
              },
              "Authorization": {
                  "tenants": "system"
              }
          }

        if_not_exists: true


nginx:
  proxy_caches:
    zoonavigator: keys_zone=zoonavigator:1m max_size=2m

  https:
    location /jupyter:
      - auth_request /jupyter_cookie_introspect
      - auth_request_set $authorization $upstream_http_authorization
      - proxy_set_header Authorization $authorization

      - auth_request_set $cookie $upstream_http_cookie
      - proxy_set_header Cookie $cookie
      - proxy_pass http://{{NODE_ID}}:9001
      - proxy_redirect off
      - error_page 403 /auth
      - error_page 401 /auth/api/openidconnect/authorize?response_type=code&scope=cookie&client_id=jupyter&redirect_uri={{PUBLIC_URL}}$request_uri

    location /jupyter_cookie_introspect:
      - internal
      - proxy_method POST
      - proxy_set_body "$http_authorization"
      - proxy_set_header X-Request-URI "request_uri"
      - proxy_pass http://upstream-seacat-auth-private/nginx/introspect/cookie?client_id=jupyter&resource=jupyter:access
      - proxy_cache jupyter
      - proxy_cache_key $cookie_SeaCatSCI_TELKL64KRVI4CQJO
      - proxy_cache_lock on
      - proxy_cache_valid 200 10s
      - proxy_ignore_headers Cache-Control Expires Set-Cookie

seacat-auth:
  content:
  - "cl.json": |
      [{
        "_id": "jupyter",
        "application_type": "web",
        "authorize_anonymous_users": false,
        "client_name": "Jupyter Notebook",
        "code_challenge_method": "none",
        "grant_types": [
          "authorization_code"
        ],
        "redirect_uri_validation_method": "prefix_match",
        "redirect_uris": [
          "{{PUBLIC_URL}}/jupyter"
        ],
        "response_types": [
          "code"
        ],
        "token_endpoint_auth_method": "none",
        "cookie_entry_uri": "{{PUBLIC_URL}}/api/cookie-entry",
        "client_uri": "{{PUBLIC_URL}}/jupyter"
      }]
  - "rs.json": |
      [{
        "_id": "jupyter:access",
        "description": "Access Jupyter Notebook."
      }]