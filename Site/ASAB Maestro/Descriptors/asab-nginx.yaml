define:
  type: rc/descriptor
  name: NGINX with ASAB Web UI distribution script
  url: https://nginx.org

descriptor:
  image: docker.teskalabs.com/lmio/distribution-nginx

  volumes:
    - {{SITE}}/{{INSTANCE_ID}}/conf.d:/etc/nginx/conf.d
    - {{SLOW_STORAGE}}/{{INSTANCE_ID}}/cache:/cache
    - {{SLOW_STORAGE}}/{{INSTANCE_ID}}/webroot:/webroot
    - {{SLOW_STORAGE}}/{{INSTANCE_ID}}/acme.sh:/acme.sh
    - {{SLOW_STORAGE}}/{{INSTANCE_ID}}/logs:/var/log/nginx

  healthcheck:
    test: ["CMD", "service", "nginx", "status"]
    interval: 60s
    timeout: 10s
    retries: 5
    start_period: 10s


secrets:
  - "private-key.pem": |
      -----BEGIN PRIVATE KEY-----
      MIG6AgEAMBQGByqGSM49AgEGCSskAwMCCAEBCwSBnjCBmwIBAQQwOtWN1PzVvbdi
      Q4vdeaiP9fIS2rqDwG2cTZg1ULJ7PpR6+TpBMnVJKqr+TDqjan/5oWQDYgAEcsC5
      1VxsEKxBIPTHUdKZU14RFmbdL+UfOqO+laGMmtfuX3ABTfHLAyNaDUrgpTD7cjqj
      wLNtZYt3rC19B07mz8lFcR1pA9p0+dZ1+KCO667OGOI87/jim8P85tfjae3R
      -----END PRIVATE KEY-----

  - "certificate.pem": |
      -----BEGIN CERTIFICATE-----
      MIIB2DCCAV+gAwIBAgIBATAKBggqhkjOPQQDAjAsMRUwEwYDVQQKEwxhc2FiLW1h
      ZXN0cm8xEzARBgNVBAMTCmFzYWIubG9jYWwwIBcNMjMwNDAxMDAwMDAwWhgPMjA1
      MzAzMzEyMzU5NTlaMCwxFTATBgNVBAoTDGFzYWItbWFlc3RybzETMBEGA1UEAxMK
      YXNhYi5sb2NhbDB6MBQGByqGSM49AgEGCSskAwMCCAEBCwNiAARywLnVXGwQrEEg
      9MdR0plTXhEWZt0v5R86o76VoYya1+5fcAFN8csDI1oNSuClMPtyOqPAs21li3es
      LX0HTubPyUVxHWkD2nT51nX4oI7rrs4Y4jzv+OKbw/zm1+Np7dGjTzBNMAwGA1Ud
      EwEB/wQCMAAwHQYDVR0OBBYEFMCHb+tdt8wIVQ7pncstqXoKrDSNMAsGA1UdDwQE
      AwIF4DARBglghkgBhvhCAQEEBAMCBkAwCgYIKoZIzj0EAwIDZwAwZAIwI37fe8tt
      50QEOftub4H6iCS5t5UCgg9FFTnQI+dRq3Rf/UOE9t/TAncc0ytqcO5EAjAQG1Qk
      HLY3LQJosmKPpseeU5O5Xsw67GRdaSxL7enu8CDkIolY3d3Hu5D814z+3IU=
      -----END CERTIFICATE-----

files:
  - "conf.d/default.conf": |
      include conf.d/api/*.upstream.conf;

  - "conf.d/http_default.conf": |
      server {
          listen 80 default_server;
          # TODO: listen [::]:80 default_server;

          server_name _;
          server_tokens off;

          add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
          add_header X-Frame-Options DENY;
          add_header X-Content-Type-Options nosniff;

          # ACME challenge is handled by a ASAB Remote Control
          location ~ ^/\.well-known/acme-challenge/([-_a-zA-Z0-9]+)$ {
            proxy_pass  http://asab-remote-control;
          }

          # Redirect everything to HTTPS
          return 301 https://$host$request_uri;
      }

  - "conf.d/https_default.conf": |
      server {
          listen 443 ssl http2 default_server;
          # TODO: listen [::]:443 ssl http2 default_server;

          server_name _;
          server_tokens off;

          ssl_certificate           /run/secrets/asab-nginx-1__certificate.pem;
          ssl_certificate_key       /run/secrets/asab-nginx-1__private-key.pem;
          ssl_trusted_certificate   /run/secrets/asab-nginx-1__certificate.pem;

          ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
          ssl_session_timeout 1d;
          ssl_prefer_server_ciphers on;

          add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
          add_header X-Frame-Options DENY;
          add_header X-Content-Type-Options nosniff;

          location / {
            root /webroot/lmio-webui/dist;
          }

          location /auth {
            alias /webroot/seacat-auth-webui/dist;
          }
      }

  # The internal API Gateway
  - "conf.d/http_api.conf": |
      server {
          listen 8890;

          server_name _;
          server_tokens off;

          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection "Upgrade";

          include conf.d/api/*.location.conf;
      }

  - "conf.d/api/asab-governator.location.conf": |
      location /api/asab-governator-1 {
        rewrite   ^/api/asab-governator-1/(.*) /$1 break;
        proxy_pass  http://asab-governator-1:8891;
        proxy_set_header X-ASAB-BaseURI /api/asab-governator-1;
      }

  - "conf.d/api/asab-library.location.conf": |
      location /api/asab-library-1 {
        rewrite   ^/api/asab-library-1/(.*) /$1 break;
        proxy_pass  http://asab-library-1:8893;
        proxy_set_header X-ASAB-BaseURI /api/asab-library-1;
      }

  - "conf.d/api/asab-remote-control.upstream.conf": |
      upstream asab-remote-control {
        server asab-remote-control-1:8890;
      }
