define:
  type: rc/descriptor
  name: ASAB Iris

descriptor:

  image: docker.teskalabs.com/asab/asab-iris

  volumes:
    # For a persistency of the configuration
    - "{{SITE}}/{{INSTANCE_ID}}/conf:/conf:ro"

asab:
  configname: conf/asab-iris.conf
  config:
    kafka:
      topic: notifications
      group_id: asab-iris
    # [smtp] must be filled from general confguration (user)
    # [slack] must be filled from general confguration (user)
    # [variables] must be filled from general confguration (user)
    email:
      markdown_wrapper: /Templates/Wrapper/Markdown Wrapper.html
    variables:
      public_url: "{{PUBLIC_URL}}"

asab-config:
  asab-iris:
    __schema__:
      file:
        {
          "title": "asab-iris",
          "type": "object",
          "properties": {
            "slack": {
              "title": "Slack",
              "description": "Configure connection to Slack channel.",
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "token": {
                  "type": "string",
                  "title": "Token",
                  "minLength": 1,
                  "$defs": {
                    "password": {
                      "type": "password"
                      }
                    }
                },
                "channel": {
                  "type": "string",
                  "title": "Channel",
                  "minLength": 1
                }
              },
              "if": { "minProperties": 1 },
              "then": { "required": ["token", "channel"] }
            },
            "msteams": {
              "title": "Microsoft Teams",
              "description": "Configure connection to MS Teams.",
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "webhook_url": {
                  "title": "Webhook URL",
                  "type": "string",
                  "format": "uri",
                  "minLength": 1
                }
              },
              "if": { "minProperties": 1 },
              "then": { "required": ["webhook_url"] }
            },
            "m365_email": {
              "title": "Microsoft 365 Email",
              "description": "Configure Graph API for sending mail via M365.",
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "api_url": {
                  "type": "string",
                  "title": "API URL",
                  "format": "uri",
                  "minLength": 1
                },
                "tenant_id": {
                  "type": "string",
                  "title": "Tenant ID",
                  "minLength": 1
                },
                "client_id": {
                  "type": "string",
                  "title": "Client ID",
                  "minLength": 1,
                  "$defs": {
                    "password": {
                      "type": "password"
                      }
                    }
                },
                "client_secret": {
                  "type": "string",
                  "title": "Client Secret",
                  "minLength": 1
                },
                "user_email": {
                  "type": "string",
                  "title": "User Email",
                  "format": "email",
                  "minLength": 1
                }
              },
              "if": { "minProperties": 1 },
              "then": {
                "required": [
                  "api_url",
                  "tenant_id",
                  "client_id",
                  "client_secret",
                  "user_email"
                ]
              }
            },
            "sms": {
              "title": "SMS",
              "description": "Configure connection to SMSBr√°na.",
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "login": {
                  "type": "string",
                  "title": "Login",
                  "minLength": 1
                },
                "password": {
                  "type": "string",
                  "title": "Password",
                  "minLength": 1,
                  "$defs": {
                    "password": {
                      "type": "password"
                      }
                    }
                },
                "api_url": {
                  "type": "string",
                  "title": "API URL",
                  "format": "uri",
                  "minLength": 1
                }
              },
              "if": { "minProperties": 1 },
              "then": { "required": ["login", "password", "api_url"] }
            }
          },
          "additionalProperties": false,
          "anyOf": [
            { "required": ["slack"] },
            { "required": ["msteams"] },
            { "required": ["m365_email"] },
            { "required": ["sms"] }
          ]
        }
    config:
      file: {}
      if_not_exists: true

nginx:
  api: 8896
